<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mapper.ShoppingCartMapper">

    <!--enable mybatis default cache configure reference:
        https://mybatis.github.io/mybatis-3/zh/sqlmap-xml.html#cache
    -->
    <!--<cache/>-->

    <sql id="shoppingCartColumns">
        ${alias}.cart_id
        ,${alias}.user_id
        ,${alias}.sku_id
        ,${alias}.item_id
        ,${alias}.amount
        ,${alias}.price
        ,${alias}.create_at
        ,${alias}.destroy_at
        ,${alias}.update_at
        ,${alias}.order_id
        ,${alias}.status
    </sql>

    <sql id="orderColumns">
        ${alias}.order_id          ,
        ${alias}.user_id           ,
        ${alias}.pay_total         ,
        ${alias}.pay_method         ,
        to_char(${alias}.order_create_at, 'YYYY-MM-DD HH24:MI:SS') order_create_at,
        ${alias}.order_ip          ,
        ${alias}.pg_trade_no       ,
        ${alias}.order_status      ,
        ${alias}.error_str         ,
        ${alias}.discount          ,
        ${alias}.updated_at        ,
        ${alias}.order_desc        ,
        ${alias}.add_id            ,
        ${alias}.ship_fee
    </sql>

    <!---  获取用户购物车,以用户ID或者CartID    -->

    <select id="getCartByID" resultType="domain.Cart" parameterType="domain.Cart">
        select
        <include refid="shoppingCartColumns">
            <property name="alias" value="t"/>
        </include>
        from sp_cart t
        where 1=1
        <if test="cartId!=null and cartId !=''">
            and t.cart_id = #{cartId}
        </if>
        <if test="userId!=null and userId !=''">
            and t.user_id = #{userId}
        </if>
        <if test="orderId!=null and orderId !=''">
            and t.status in ('O')
            and t.order_id = #{orderId}
        </if>
        <if test="orderId==null or orderId ==''">
            and t.status in ('I','S','G')
        </if>
        ORDER BY t.create_at DESC,t.sku_id
    </select>


    <select id="getCartByUserSku" resultType="domain.Cart" parameterType="domain.Cart">
        select
        <include refid="shoppingCartColumns">
            <property name="alias" value="t"/>
        </include>
        from sp_cart t
        where 1=1 and t.status in ('I','G')
        <if test="cartId!=null and cartId !=''">
            and t.cart_id = #{cartId}
        </if>
        <if test="userId!=null and userId !=''">
            and t.user_id = #{userId}
        </if>
        <if test="skuId!=null and skuId !=''">
            and t.sku_id = #{skuId}
        </if>
        <if test="itemId!=null and itemId !=''">
            and t.item_id = #{itemId}
        </if>
        ORDER BY t.create_at DESC,t.sku_id
    </select>

    <!-- 更新价格,状态,数量,删除 -->
    <update id="updateCart" parameterType="domain.Cart">
        update sp_cart  set update_at= CURRENT_TIMESTAMP(0)
        <if test="userId != null and userId!=''">
            ,user_id=#{userId}
        </if>
        <if test="skuId != null and skuId!=''">
            ,sku_id=#{skuId}
        </if>
        <if test="itemId != null and itemId!=''">
            ,item_id=#{itemId}
        </if>
        <if test="amount != null and amount!=''">
            ,amount=#{amount}
        </if>
        <if test="price != null and price!=''">
            ,price=#{price}
        </if>
        <if test="destroyAt != null and destroyAt!=''">
            ,destroy_at=CURRENT_TIMESTAMP(0)
        </if>
        <if test="orderId != null and orderId!=''">
            ,order_id=#{orderId}
        </if>
        <if test="status != null and status!=''">
            ,status=#{status}
        </if>
        <if test="skuTitle != null and skuTitle!=''">
            ,sku_title=#{skuTitle}
        </if>
        where 1=1
        <if test="cartId!=null and cartId !=''">
            and cart_id = #{cartId}
        </if>
        <if test="userId!=null and userId !=''">
            and user_id = #{userId}
        </if>
        <if test="status!=null and status !=''">
            and status in ('I','G')
        </if>
    </update>

    <insert id="addCart" parameterType="domain.Cart" useGeneratedKeys="true" keyProperty="cartId">
        insert into sp_cart (user_id
        ,sku_id
        ,item_id
        ,amount
        ,price
        ,status
        ,sku_title
        ,sku_img
        ,create_at)
        values(#{userId},
        #{skuId},
        #{itemId},
        #{amount},
        <if test="price != null and price!=''">
            #{price},
        </if>
        <if test="price == null or price==''">
            default,
        </if>
        <if test="status != null and status!=''">
            #{status},
        </if>
        <if test="status == null or status==''">
            default,
        </if>
        <if test="skuTitle != null and skuTitle!=''">
            #{skuTitle},
        </if>
        <if test="skuTitle == null or skuTitle==''">
            default,
        </if>
        <if test="skuImg != null and skuImg!=''">
            #{skuImg},
        </if>
        <if test="skuImg == null or skuImg==''">
            default,
        </if>
        CURRENT_TIMESTAMP(0)
        )
    </insert>

    <!--查询用户订单-->
    <select id="getOrderBy" parameterType="domain.Order" resultType="domain.Order">
        select
        <include refid="orderColumns">
            <property name="alias" value="t"/>
        </include>
        from sp_order t
        where 1=1
        <if test="userId!=null and userId !=''">
            and t.user_id = #{userId}
        </if>
        <if test="orderId!=null and orderId !=''">
            and t.order_id = #{orderId}
        </if>
    </select>

    <update id="updateOrder" parameterType="domain.Order">
        update sp_order set order_status = orderStatus where 1=1
        <if test="userId!=null and userId !=''">
            and user_id = #{userId}
        </if>
        <if test="orderId!=null and orderId !=''">
            and order_id = #{orderId}
        </if>
    </update>

    <!---优惠券-->
    <sql id="couponColumns">
        ${alias}.coup_id        ,
        ${alias}.user_id        ,
        ${alias}.cate_id        ,
        ${alias}.denomination   ,
        ${alias}.start_at,
        ${alias}.end_at,
        ${alias}.state          ,
        ${alias}.order_id       ,
        ${alias}.use_at
    </sql>
    <select id="getUserCoupon" parameterType="domain.CouponVo" resultType="domain.CouponVo">
        select
        <include refid="couponColumns">
            <property name="alias" value="t"/>
        </include>
        from sp_coupons t
    </select>
    <insert id ="insertCoupon" parameterType="domain.CouponVo" >
        insert into sp_coupons (coup_id,
            user_id,
            cate_id,
            denomination,
            start_at,
            end_at,
            state
        ) values(
            #{coupId},
            #{userId},
            #{cateId},
            #{denomination},
            #{startAt},
            #{endAt},
            #{state}
        )
    </insert>

    <update id="updateCoupon" parameterType="domain.CouponVo">
        update sp_coupons set coup_id = coup_id
        <if test="userId!=null and userId!=''">
            ,user_id = #{userId}
        </if>
        <if test="cateId!=null and cateId!=''">
            ,cate_id = #{cateId}
        </if>
        <if test="denomination!=null and denomination!=''">
            ,denomination = #{denomination}
        </if>
        <if test="startAt!=null and startAt!=''">
            ,start_at = #{startAt}
        </if>
        <if test="endAt!=null and endAt!=''">
            ,end_at = #{endAt}
        </if>
        <if test="state!=null and state!=''">
            ,state =#{state}
        </if>
        <if test="useAt!=null and useAt!=''">
            ,use_at=#{useAt}
        </if>
        where 1= 1
        <if test="coupId!=null and coupId !=''">
            and coup_id = #{coupId}
        </if>
        <if test="userId!=null and userId!=''">
            and user_id =#{userId}
        </if>
        <if test="state!=null and state!=''">
            and state = #{state}
        </if>
        <if test="cateId!=null and cateId!=''">
            and cate_id =#{cateId}
        </if>
    </update>

</mapper>
